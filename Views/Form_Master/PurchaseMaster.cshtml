
@{
    ViewData["Title"] = "PurchaseMaster";
}

<title>Purchase Entry Form</title>
<div class="container mt-5">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h5>Purchase Order Entry</h5>
            <!-- Save and Cancel Buttons -->
            <div class="col-12 mt-4 text-end">
                <button type="submit" class="btn btn-success" onclick="SavePurchaseDetail()" id="submitButton">Save</button>
                <button type="button" class="btn btn-success" id="updateButton" onclick="updatePurchaseForm()" style="display: none;">Update</button>
                <button type="button" class="btn btn-secondary" onclick="location.href='@Url.Action("POEntryList", "Home")'">Cancel</button>
            </div>
        </div>
        <div class="card-body">
            <form>
                <div class="row g-3">
                     <div class="col-md-6">
                            <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="orderNo" placeholder="code" readonly/>
                        <label for="orderNo">Order No</label>
                        </div>
                        </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="orderDate" placeholder="cal" readonly />
                            <label for="orderDate">Order Date</label>
                        </div>
                    </div>

                    <!-- Vendor -->
                    <div class="col-12">
                        <div class="form-floating">
                            <select class="form-select" id="vendor">
                                <option value="" selected>Select vendor</option>
                            </select>
                            <label for="vendor">Vendor</label>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="col-12">
                        <div class="form-floating">
                            <textarea class="form-control" id="notes" placeholder="Notes" style="height: 100px;"></textarea>
                            <label for="notes">Notes</label>
                        </div>
                    </div>

                    <!-- Order Value -->
                    <div class="col-12">
                        <div class="form-floating col-6">
                            <input type="text" class="form-control" id="orderValue" placeholder="Order Value" readonly/>
                            <label for="orderValue">Order Value</label>
                        </div>
                    </div>

                    <!-- Material, Code, Short Text, and Unit -->
                    
                    <div class="col-md-4">
                        <div class="form-floating">
                            <select class="form-select" id="code">
                                <option value="">Select Code</option>
                            </select>
                            <label for="code">Code</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating">
                            <select class="form-select" id="shortText">
                                <option value="" >Select ShortTxt</option>
                            </select>
                            <label for="shortText">Short Text</label>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="unit" placeholder="Unit" readonly />
                            <label for="unit">Unit</label>
                        </div>
                    </div>
                    <!-- Quantity, Rate, Amount, Expected Date -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="tel" class="form-control" id="quantity" placeholder="Quantity" oninput="validateQuantity();updateAmount()" />
                            <label for="quantity">Quantity</label>
                            <small id="quantityError" style="color: red; display: none;">Please enter a valid number.</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="tel" class="form-control" id="rate" placeholder="Rate" oninput="validateRate();updateAmount();"/>
                            <label for="rate">Rate</label>
                            <small id="rateError" style="color: red; display: none;">Please enter a valid number.</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="amount" placeholder="Amount" readonly />
                            <label for="amount">Amount</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="expectedDate" placeholder="expectedDate"  min=""/>
                            <label for="expectedDate">Expected Date</label>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-primary" onclick="AddPurchaseToTable()">Add Line</button>
                            <button type="button" class="btn btn-secondary" onclick="bindRowToFields()">Update Line</button>
                            <button type="button" class="btn btn-danger" onclick="removeSelectedLines()">Remove Line</button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="col-12 mt-4">
                        <table class="table table-bordered">
                            <thead class="table-primary">
                                <tr>
                                    <th>Select</th>
                                    <th>Code</th>
                                    <th>Quantity</th>
                                    <th>Rate</th>
                                    <th>Amount</th>
                                    <th>Exp Date</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

             
            </form>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 10px;
    }

    .form-floating label {
        padding: 0.5rem 0.75rem;
    }
</style>

<script type="text/javascript">             
    var purchaseDetails = [];
    $(document).ready(function () {
        CurrentDate();
        loadMaterialData();
        loadVendorData();
        getQueryStringValue('Code');
        if (vendorCode != null) {
            GetPurchaseDataByCodeId(vendorCode);
        }
        const dateInput = document.getElementById('expectedDate');
        const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format
        dateInput.min = today;
    });
    var materialOrderData={};
    var orderValue;
    var amountvalue; 
    var selectedRowsData = [];
    var totalAmount=0;
    function CurrentDate(){
        const orderDateInput = document.getElementById("orderDate");
        const today = new Date().toISOString().split('T')[0]; 
        console.log("Date",today);
        orderDateInput.value = today;
    }
    function getQueryStringValue(key) {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(key);
    }
    var vendorCode = getQueryStringValue('Code');
    function validateQuantity() {
        const quantityInput = document.getElementById("quantity");
        const quantityError = document.getElementById("quantityError");
        if (quantityInput.value === "") {
            quantityError.style.display = "none"; 
        }
        else if (!/^\d+$/.test(quantityInput.value)) {
            quantityError.style.display = "block"; 
        } else {
            quantityError.style.display = "none";
        }
    }
    function validateRate() {
        const rateInput = document.getElementById("rate");
        const rateError = document.getElementById("rateError");
        if (rateInput.value === "") {
            rateError.style.display = "none";
        }
        else if (!/^\d+$/.test(rateInput.value)) {
            rateError.style.display = "block";
        } else {
            rateError.style.display = "none";
        }
    } 

    function updateAmount() {
        const quantity = document.getElementById("quantity").value;
        const rate = document.getElementById("rate").value;
        const amountInput = document.getElementById("amount");
        const orderInput = document.getElementById("orderValue");
        
        if (!isNaN(quantity) && !isNaN(rate) && quantity !== "" && rate !== "") {
            amountInput.value = (parseFloat(quantity) * parseFloat(rate)).toFixed(2); 
           // orderInput.value= amountInput.value
        } else {
            amountInput.value = "";
        }
    }

    function loadVendorData() {
        $.ajax({
            url: '/Home/GetVendorData', // Your controller action URL
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                console.log("Vendor Data", data);

                var dropdownCodeVendor = $('#vendor');
                dropdownCodeVendor.empty();
                dropdownCodeVendor.append('<option value="" selected>Select Vendor</option>');
                // Iterate over the data and append options to the dropdown
                data.forEach(function (vendor) {
                    dropdownCodeVendor.append(new Option(vendor.name));
                });

            },
            error: function (xhr, status, error) {
                console.error('Error loading vendor data:', error);
                $('#vendorData').html('<p>Error loading vendor data.</p>');
            }
        });

    }
    function AddPurchaseToTable() {
        $('#purchaseTableBody tr').each(function () {
            var $row = $(this);
            const MCode = $row.find('td:eq(1)').text(); // Get MCode from the row
            const Quantity = parseInt($row.find('td:eq(2)').text(), 10); // Get Quantity and convert to number

            // Find the matching Material Data object by MCode
            const material = materialData.find(item => item.code === MCode);

            if (material) {
                const minOrderQuantity = parseInt(material.minOrderQuantity, 10);

                // Check if Quantity exceeds minOrderQuantity
                if (Quantity > minOrderQuantity) {
                    // Add a warning or handle the validation
                    alert(`Quantity (${Quantity}) for MCode ${MCode} exceeds the minimum order quantity (${minOrderQuantity}).`);
                    $row.css('background-color', '#f8d7da'); // Highlight row in red (optional)
                    return;
                }
            } else {
                console.warn(`Material data not found for MCode: ${MCode}`);
            }
          purchaseDetail = {
            OrderDate: $('#orderDate').val(),
            Vendor: $('#vendor').val(),
            Notes: $('#notes').val(),
            OrderValue: $('#orderValue').val(),
            Code: $('#code').val(),
            ShortTxt: $('#shortText').val(),
            Unit: $('#unit').val(),
            Quantity: $('#quantity').val(),
            Rate: $('#rate').val(),
            ExpectedDate: $('#expectedDate').val(),
            Amount: $('#amount').val(),
        };
          
            var rowData = {
                Code: $row.find('td:eq(1)').text(), // Code
                Quantity: $row.find('td:eq(2)').text(), // Quantity
                Rate: $row.find('td:eq(3)').text(), // Rate
                Amount: $row.find('td:eq(4)').text(), // Amount
                ExpectedDate: $row.find('td:eq(5)').text() // Exp Date
            };
            purchaseDetails.push(rowData);

            console.log("", rowData)
        });
       
        console.log("",selectedRowsData);
        console.log("",totalAmount);
        var code= $('#code').val();
        var quantity = $('#quantity').val();
        var expectedDate= $('#expectedDate').val();
        var amount = $('#amount').val();
        var rate = $('#rate').val();
        if (!code || !quantity || !rate || !amount || !expectedDate ) {
            alert("Please fill in all required fields.");
            return false;
        }
        totalAmount += parseFloat(amount) || 0;
        $('#orderValue').val(totalAmount);
        // Create new row with the collected data
        var newRow = `
            <tr>
                <td><input type="checkbox" /></td>
                <td>${code}</td>
                <td>${quantity}</td>
                <td>${rate}</td>
                <td>${amount}</td>
                <td>${expectedDate}</td>
            </tr>
        `;

        // Append the new row to the table
        $('#purchaseTableBody').append(newRow);
        $('#code').val('');
        $('#quantity').val('');
        $('#rate').val('');
        $('#amount').val('');
        $('#expectedDate').val('');
        $('#purchaseTableBody').on('change', 'input[type="checkbox"]', function () {
            const $row = $(this).closest('tr');

            if ($(this).is(':checked')) {
                // Make editable by converting cells to input fields
                $row.find('td:nth-child(2), td:nth-child(3), td:nth-child(4), td:nth-child(6)').each(function () {
                    const currentValue = $(this).text();
                    $(this).html(`<input type="text" value="${currentValue}" class="form-control" />`);
                });
                const $quantityInput = $row.find('td:nth-child(3) input');
                const $rateInput = $row.find('td:nth-child(4) input');
                const $amountCell = $row.find('td:nth-child(5)');

                function calculateAmount() {
                    const quantity = parseFloat($quantityInput.val()) || 0;
                    const rate = parseFloat($rateInput.val()) || 0;
                    const amount = (quantity * rate).toFixed(2); // Calculate Amount
                    $amountCell.text(amount); // Update Amount cell
                }

                $quantityInput.on('input', calculateAmount);
                $rateInput.on('input', calculateAmount);
            } else {
                // Revert back to plain text when unchecked
                $row.find('td:nth-child(2), td:nth-child(3), td:nth-child(4), td:nth-child(6)').each(function () {
                    const inputValue = $(this).find('input').val();
                    $(this).text(inputValue);
                });
            }
        });
    }
    function removeSelectedLines() {
        $('#purchaseTableBody input[type="checkbox"]:checked').each(function () {
            $(this).closest('tr').remove(); // Remove the row containing the checkbox
        });
    }
    function SavePurchaseDetail() {
        if(!formValidation()){
            return;
        }
        
        $('#purchaseTableBody tr').each(function () {
            var $row = $(this);
            var rowData = {
                MCode: $row.find('td:eq(1)').text(), // Code
                Quantity: $row.find('td:eq(2)').text(), // Quantity
                Rate: $row.find('td:eq(3)').text(), // Rate
                Amount: $row.find('td:eq(4)').text(), // Amount
                Expected_Date: $row.find('td:eq(5)').text() // Exp Date
            };
            purchaseDetails.push(rowData);
        });

        if (purchaseDetails.length === 0) {
            alert("No data to save.");
            return;
        }
         purchaseDetail = {
            OrderDate: $('#orderDate').val(),
            Vendor: $('#vendor').val(),
            Notes: $('#notes').val(),
            ShortTxt: $('#shortText').val(),
            Unit: $('#unit').val(),
            OrderValue:$('#orderValue').val() ,
            purchaseItems: purchaseDetails
        };
        $.ajax({
            url: '/Form_Master/SavePurchaseDetail',
            data: JSON.stringify(purchaseDetail),
            type: 'POST',
            contentType: "application/json",
            dataType: "json",
            success: function (response) {
                if (response.success) {
                    alert("Purchase has been added successfully");
                    window.location.href = '@Url.Action("POEntryList", "Home")';
                } else {
                    alert({ message: "An error occurred" })
                }
            },
            error: function (xhr, status, error) {
                console.error("Error:", error);
                errorCallback({ message: "An error occurred" });
            }
        });
    }
    function GetPurchaseDataByCodeId(vendorCode) {
        $.ajax({
            url: '/Form_Master/GetPurchaseDataByVendorCode',
            data: JSON.stringify({ OrderNo: vendorCode }),
            type: 'POST',
            contentType: "application/json",
            dataType: "json",
            success: function (response) {
                if (response) {
                    console.log("vendor res", response);
                    var item = response[0];
                    document.getElementById("orderNo").value = item.pCode || "";
                    document.getElementById("orderDate").value = item.orderDate || "";
                    document.getElementById("vendor").value = item.vendor|| "";
                    console.log("vendor",item.vendor)
                    document.getElementById("notes").value = item.notes
                        || ""; // Format date to yyyy-MM-dd for input[type="date"]
                    document.getElementById("orderValue").value = item.orderValue || "";
                    document.getElementById("code").value = item.mCode || "";
                    document.getElementById("shortText").value = item.shortTxt || "";
                    document.getElementById("unit").value = item.unit || "";
                    document.getElementById("quantity").value = item.quantity || "";
                    document.getElementById("rate").value = item.rate || "";
                    document.getElementById("expectedDate").value = item.expected_Date || "";
                    document.getElementById("amount").value = item.amount || "";
                    
                    document.getElementById("submitButton").style.display = "none";
                    document.getElementById("updateButton").style.display = "inline-block";
                } else {
                    alert({ message: "An error occurred" })
                }
            },
            error: function (xhr, status, error) {
                console.error("Error:", error);
                errorCallback({ message: "An error occurred" });
            }
        });
    }
    function updatePurchaseForm() {
        if(!formValidation()){
            return;
        }
        $('#purchaseTableBody tr').each(function () {
            var $row = $(this);
            var rowData = {
                MCode: $row.find('td:eq(1)').text(), // Code
                Quantity: $row.find('td:eq(2)').text(), // Quantity
                Rate: $row.find('td:eq(3)').text(), // Rate
                Amount: $row.find('td:eq(4)').text(), // Amount
                Expected_Date: $row.find('td:eq(5)').text() // Exp Date
            };
            purchaseDetails.push(rowData);
        });

        if (purchaseDetails.length === 0) {
            alert("No data to save.");
            return;
        }
        purchaseDetail = {
           OrderNo:vendorCode,
            OrderDate: $('#orderDate').val(),
            Vendor: $('#vendor').val(),
            Notes: $('#notes').val(),
            ShortTxt: $('#shortText').val(),
            Unit: $('#unit').val(),
            OrderValue: $('#orderValue').val(),
            purchaseItems: purchaseDetails
        };
        console.log("rkerlew",purchaseDetail);
        $.ajax({
            url: '/Form_Master/UpdatePurchaseDetail',
            data: JSON.stringify(purchaseDetail),
            type: 'POST',
            contentType: "application/json", 
            dataType: "json",
            success: function (response) {
                if (response.success) {
                    alert("Purchase has been updated successfully");
                    window.location.href = '@Url.Action("POEntryList", "Home")';
                } else {
                    alert({ message: "An error occurred" })
                }
            },
            error: function (xhr, status, error) {
                console.error("Error:", error);
                errorCallback({ message: "An error occurred" });
            }
        });
    }
    function updateShortTextDropdown(code) {
        var dropdownShortText = $('#shortText');
        dropdownShortText.empty();
        dropdownShortText.append('<option value="" selected>Select ShortTxt</option>');

        var filteredShortTexts = materialOrderData.filter(function (item) {
            return item.code === code;
        });
        filteredShortTexts.forEach(function (item) {
            dropdownShortText.append(new Option(item.shortTxt, item.shortTxt));
        });
    }
    function updateUnitField(shortTxt) {
        var selectedItem = materialOrderData.find(function (item) {
            return item.shortTxt === shortTxt;
        });

        if (selectedItem) {
            $('#unit').val(selectedItem.unit); // Set the Unit value in the input field
        } else {
            $('#unit').val(''); // Reset Unit if no valid ShortTxt is selected
        }
    }
    function loadMaterialData() {
        $.ajax({
            url: '/Home/GetMaterialData',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                console.log("Material Data", data);
                materialOrderData = data;
                var dropdownCode = $('#code');
                dropdownCode.empty();
                dropdownCode.append('<option value="" selected>Select Code</option>');
                var codeOptions = [...new Set(data.map(item => item.code))]; // Get unique codes
                codeOptions.forEach(function (code) {
                    dropdownCode.append(new Option(code, code));
                });

                
                dropdownCode.change(function () {
                    var selectedCode = $(this).val();
                    updateShortTextDropdown(selectedCode);
                    $('#unit').val('');
                });
                $('#shortText').change(function () {
                    var selectedShortTxt = $(this).val();
                    updateUnitField(selectedShortTxt);
                });

            },
            error: function (xhr, status, error) {
                console.error('Error loading material data:', error);
                $('#vendorData').html('<p>Error loading material data.</p>');
            }
        });
    }
    function formValidation(){
        const inputs = document.querySelectorAll('.form-control');
        const inp = document.querySelectorAll('.form-select');
        let isValid = true;
        const purchaseTableRows = document.querySelectorAll('#purchaseTableBody tr');
        const hasPurchaseItems = purchaseTableRows.length > 0;
        inp.forEach(input=>{
            if (input.value.trim() === '') {
                input.classList.add('is-invalid'); // Add the red border
                isValid = false;
            } else {
                input.classList.remove('is-invalid'); // Remove the red border
            }
        });
        inputs.forEach(input => {
            if (input.id === 'orderNo' || input.id === 'orderDate' || input.id==='notes' ){
                return;
            }

            // Check if the field is empty
            if (input.value.trim() === '') {
                input.classList.add('is-invalid'); // Add the red border
                isValid = false;
            } else {
                input.classList.remove('is-invalid'); // Remove the red border
            }
        });
        if (hasPurchaseItems) {
            return true;
        }
        if (isValid) {
            return true;
        } else {
            alert('Please fill out all required fields.');
            return false;
        }

    }
    function bindRowToFields() {
        const $row = $('#purchaseTableBody input[type="checkbox"]:checked').closest('tr');

        if ($row.length === 0) {
            alert('Please select a row to update.');
            return;
        }

        // Revert input fields to plain text and update total amount
        let totalAmount = 0;
        $row.each(function () {
            const $row = $(this);

            // Get updated values
            const code = $row.find('td:nth-child(2) input').val();
            const quantity = parseFloat($row.find('td:nth-child(3) input').val()) || 0;
            const rate = parseFloat($row.find('td:nth-child(4) input').val()) || 0;
            const expDate = $row.find('td:nth-child(6) input').val();
            const amount = (quantity * rate).toFixed(2);

            // Update row cells
            $row.find('td:nth-child(2)').text(code);
            $row.find('td:nth-child(3)').text(quantity);
            $row.find('td:nth-child(4)').text(rate);
            $row.find('td:nth-child(5)').text(amount);
            $row.find('td:nth-child(6)').text(expDate);

            totalAmount += parseFloat(amount) || 0;

            // Uncheck the checkbox after updating
            $row.find('input[type="checkbox"]').prop('checked', false);
        });

        // Update the total order value
        $('#orderValue').val(totalAmount);
    }
    ////function enableEditing() {
    //    const selectedRow = $('#purchaseTableBody input[type="checkbox"]:checked').closest('tr');

    //    if (selectedRow.length === 0) {
    //        alert('Please select a row to edit.');
    //        return;
    //    }

    //    // Make the selected row cells editable
    //    selectedRow.find('td:nth-child(2), td:nth-child(3), td:nth-child(4), td:nth-child(6)').each(function () {
    //        const currentValue = $(this).text();
    //        $(this).html(`<input type="text" value="${currentValue}" class="form-control" />`);
    //    });

    //    // Disable the checkbox to avoid re-selection
    //    selectedRow.find('input[type="checkbox"]').prop('disabled', true);
    //}

    //function updateRow() {
    //    const selectedRow = $('#purchaseTableBody input[type="checkbox"]:disabled').closest('tr');

    //    if (selectedRow.length === 0) {
    //        alert('No row selected for updating. Please edit a row first.');
    //        return;
    //    }

    //    // Extract updated values from the input fields
    //    const code = selectedRow.find('td:nth-child(2) input').val();
    //    const quantity = selectedRow.find('td:nth-child(3) input').val();
    //    const rate = selectedRow.find('td:nth-child(4) input').val();
    //    const expDate = selectedRow.find('td:nth-child(6) input').val();
    //    const amount = (parseFloat(quantity) * parseFloat(rate)).toFixed(2);

    //    // Update the row with new values
    //    selectedRow.find('td:nth-child(2)').html(code);
    //    selectedRow.find('td:nth-child(3)').html(quantity);
    //    selectedRow.find('td:nth-child(4)').html(rate);
    //    selectedRow.find('td:nth-child(5)').html(amount);
    //    selectedRow.find('td:nth-child(6)').html(expDate);

    //    // Re-enable the checkbox
    //    selectedRow.find('input[type="checkbox"]').prop('disabled', false);

    //    // Update the total amount
    //    totalAmount = 0;
    //    $('#purchaseTableBody tr').each(function () {
    //        const rowAmount = parseFloat($(this).find('td:nth-child(5)').text()) || 0;
    //        totalAmount += rowAmount;
    //    });
    //    $('#orderValue').val(totalAmount);
    //}

</script>
